import logging
import threading
import time

from flask import Flask, jsonify, request, render_template_string

from .config import load_config, save_config, setup_logging, is_config_complete
from .miner import Miner
from .watchdog import Watchdog
from .miner_downloader import ensure_cpuminer_binary, ensure_srbminer


def _strip_stratum_prefix(pool_url: str) -> str:
    """
    把 stratum+tcp://pool.scash.pro:8888 转成 pool.scash.pro:8888
    供 SRBMiner 使用。
    """
    if not pool_url:
        return ""
    for prefix in ("stratum+tcp://", "stratum+ssl://", "stratum://"):
        if pool_url.startswith(prefix):
            return pool_url[len(prefix) :]
    return pool_url


HTML_PAGE = r"""
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>SCASH Manager 控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 880px;
      margin: 32px auto;
      padding: 24px;
      background: #020617;
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #22d3ee, #6366f1);
      color: #0f172a;
      font-weight: 900;
      font-size: 16px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(21,128,61,0.3);
      color: #bbf7d0;
    }
    .badge.off {
      background: rgba(127,29,29,0.5);
      color: #fecaca;
    }
    .section {
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid #1e293b;
    }
    .section h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #e5e7eb;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .controls {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      color: #022c22;
    }
    .btn-danger {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #111827;
    }
    .btn-ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #374151;
    }
    .log {
      margin-top: 12px;
      padding: 8px;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1e293b;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #9ca3af;
    }
    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }
    .msg {
      font-size: 12px;
      color: #9ca3af;
    }
    .msg.error {
      color: #fecaca;
    }
    @media (max-width: 680px) {
      .container {
        margin: 10px;
        padding: 16px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span class="logo">S</span>
      <span>SCASH Manager</span>
    </h1>
    <div class="subtitle">
      轻量级 SCASH 挖矿管家 · Web 控制台 + 看门狗 · Docker 开箱即用
    </div>

    <!-- 首次设置向导 -->
    <div id="setup-section" class="section" style="display:none;">
      <h2>首次配置向导</h2>
      <p style="font-size:13px;color:#9ca3af;margin-top:2px;">
        第一次使用，请填写你的 SCASH 钱包与挖矿参数。保存后系统会自动写入配置并启动 Miner。
      </p>

      <label>矿工类型</label>
      <select id="setup-impl">
        <option value="cpuminer">cpuminer-scash v3.0.9（推荐，简单稳定）</option>
        <option value="srbminer">SRBMiner-MULTI v3.0.5（高级，更多参数）</option>
      </select>

      <label>SCASH 钱包地址</label>
      <input id="setup-wallet" placeholder="scash1q..." />

      <div class="grid">
        <div>
          <label>矿池</label>
          <select id="setup-pool">
            <option value="stratum+tcp://pool.scash.pro:8888">pool.scash.pro:8888</option>
            <option value="stratum+tcp://pool.rplant.xyz:17044">rplant (示例)</option>
            <option value="custom">自定义...</option>
          </select>
          <input id="setup-pool-custom" placeholder="自定义矿池 URL，例如 stratum+tcp://host:port"
                 style="margin-top:6px;display:none;" />
        </div>
        <div>
          <label>线程数（留空则自动使用 CPU 核数-1）</label>
          <input id="setup-threads" type="number" min="1" />
        </div>
      </div>

      <label style="margin-top:10px;">矿工可执行文件路径（容器内，可留空使用默认）</label>
      <input id="setup-bin" placeholder="/usr/local/bin/minerd 或 /opt/SRBMiner-Multi/SRBMiner-MULTI" />

      <div class="controls">
        <button id="btn-setup-save" class="btn-primary">保存配置并启动 Miner</button>
        <span id="setup-msg" class="msg"></span>
      </div>
    </div>

    <!-- 控制台 -->
    <div id="dashboard-section" class="section" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <h2 style="margin-bottom:4px;">运行状态</h2>
          <div id="status-badge" class="badge off">
            <span id="status-text">状态未知</span>
          </div>
          <div style="font-size:12px;color:#9ca3af;margin-top:4px;">
            当前矿工：<span id="impl-text">-</span>
          </div>
        </div>
        <div style="text-align:right;font-size:12px;color:#9ca3af;">
          钱包：<span id="wallet">-</span><br/>
          当前矿池：<span id="pool-url">-</span><br/>
          线程数：<span id="threads">-</span>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="section" style="margin-top:0;padding:10px 12px;">
          <h2 style="font-size:14px;margin-bottom:4px;">Miner</h2>
          <div style="font-size:12px;color:#9ca3af;">
            程序路径：<span id="bin-path">-</span><br/>
            算法：<span id="algo">-</span>
          </div>
        </div>
        <div class="section" style="margin-top:0;padding:10px 12px;">
          <h2 style="font-size:14px;margin-bottom:4px;">Watchdog</h2>
          <div style="font-size:12px;color:#9ca3af;">
            重启次数：<span id="restart-count">0</span><br/>
            重启间隔：<span id="restart-delay">-</span> 秒
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="btn-start" class="btn-primary">启动 Miner</button>
        <button id="btn-stop" class="btn-danger">停止 Miner</button>
        <button id="btn-refresh" class="btn-ghost">手动刷新状态</button>
        <span id="dash-msg" class="msg"></span>
      </div>

      <div class="log" id="log-box">
        状态日志将在这里显示...
      </div>
    </div>

    <div class="footer">
      SCASH Manager · Docker Edition
    </div>
  </div>

  <script>
    async function api(path, options) {
      const resp = await fetch(path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      return resp.json();
    }

    function appendLog(text) {
      const box = document.getElementById("log-box");
      if (!box) return;
      const now = new Date().toLocaleTimeString();
      box.textContent += "\\n[" + now + "] " + text;
      box.scrollTop = box.scrollHeight;
    }

    function showSetup() {
      document.getElementById("setup-section").style.display = "block";
      document.getElementById("dashboard-section").style.display = "none";
    }

    function showDashboard() {
      document.getElementById("setup-section").style.display = "none";
      document.getElementById("dashboard-section").style.display = "block";
    }

    async function refreshStatus(showMsg) {
      try {
        const data = await api("/api/status");
        if (data.needs_setup) {
          showSetup();
        } else {
          showDashboard();
        }

        if (!data.needs_setup) {
          const running = data.running;
          document.getElementById("status-text").textContent = running ? "正在运行" : "已停止";
          const badge = document.getElementById("status-badge");
          if (running) {
            badge.classList.remove("off");
          } else {
            badge.classList.add("off");
          }

          document.getElementById("wallet").textContent = data.wallet || "-";
          document.getElementById("pool-url").textContent = data.pool_url || "-";
          document.getElementById("threads").textContent = data.threads ?? "-";
          document.getElementById("bin-path").textContent = data.bin_path || "-";
          document.getElementById("algo").textContent = data.algorithm || "-";
          document.getElementById("restart-count").textContent = data.restart_count ?? 0;
          document.getElementById("restart-delay").textContent = data.restart_delay ?? "-";
          document.getElementById("impl-text").textContent = data.impl || "-";

          if (showMsg) {
            const msg = document.getElementById("dash-msg");
            msg.textContent = "状态已更新";
            setTimeout(() => (msg.textContent = ""), 1500);
          }
        }
      } catch (err) {
        console.error(err);
        appendLog("获取状态失败: " + err);
      }
    }

    async function startMiner() {
      const msg = document.getElementById("dash-msg");
      msg.textContent = "正在发送启动请求...";
      try {
        const data = await api("/api/start", { method: "POST", body: "{}" });
        if (!data.ok) {
          msg.textContent = data.error || "启动失败";
        } else {
          appendLog(data.message || "启动请求已发送");
          await refreshStatus(true);
          msg.textContent = "";
        }
      } catch (err) {
        appendLog("启动失败: " + err);
      }
    }

    async function stopMiner() {
      const msg = document.getElementById("dash-msg");
      msg.textContent = "正在发送停止请求...";
      try {
        const data = await api("/api/stop", { method: "POST", body: "{}" });
        appendLog(data.message || "停止请求已发送");
        await refreshStatus(true);
        msg.textContent = "";
      } catch (err) {
        appendLog("停止失败: " + err);
      }
    }

    async function saveSetup() {
      const impl = document.getElementById("setup-impl").value;
      const wallet = document.getElementById("setup-wallet").value.trim();
      const poolSelect = document.getElementById("setup-pool");
      let pool = poolSelect.value;
      const poolCustom = document.getElementById("setup-pool-custom").value.trim();
      const threads = document.getElementById("setup-threads").value.trim();
      const binPathInput = document.getElementById("setup-bin").value.trim();
      const msg = document.getElementById("setup-msg");

      msg.classList.remove("error");

      if (!wallet) {
        msg.textContent = "请填写钱包地址。";
        msg.classList.add("error");
        return;
      }

      if (pool === "custom") {
        if (!poolCustom) {
          msg.textContent = "请选择矿池或填写自定义矿池 URL。";
          msg.classList.add("error");
          return;
        }
        pool = poolCustom;
      }

      let threadsNum = null;
      if (threads) {
        threadsNum = parseInt(threads, 10);
        if (!threadsNum || threadsNum <= 0) {
          msg.textContent = "线程数必须是正整数。";
          msg.classList.add("error");
          return;
        }
      }

      msg.textContent = "正在保存配置并启动 Miner...";
      try {
        const payload = {
          impl,
          wallet,
          pool_url: pool,
          bin_path: binPathInput || null,
        };
        if (threadsNum) payload.threads = threadsNum;

        const data = await api("/api/setup", {
          method: "POST",
          body: JSON.stringify(payload),
        });

        if (!data.ok) {
          msg.textContent = data.error || "保存失败";
          msg.classList.add("error");
          return;
        }

        msg.textContent = "保存成功，正在启动 Miner...";
        appendLog("已保存配置并启动 Miner。");
        await refreshStatus(false);
        showDashboard();
      } catch (err) {
        msg.textContent = "请求失败: " + err;
        msg.classList.add("error");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btn-start").addEventListener("click", startMiner);
      document.getElementById("btn-stop").addEventListener("click", stopMiner);
      document.getElementById("btn-refresh").addEventListener("click", () => refreshStatus(true));
      document.getElementById("btn-setup-save").addEventListener("click", saveSetup);

      document.getElementById("setup-pool").addEventListener("change", (e) => {
        const v = e.target.value;
        const custom = document.getElementById("setup-pool-custom");
        custom.style.display = v === "custom" ? "block" : "none";
      });

      refreshStatus(false);
      setInterval(refreshStatus, 5000);
    });
  </script>
</body>
</html>
"""

app = Flask(__name__)

# 初始化全局状态
_cfg = load_config(allow_missing=True)
setup_logging(_cfg or {})
logging.info("SCASH Manager WebApp 启动中...")

# 根据配置决定预下载哪个 miner（cpuminer / srbminer）
miner_cfg = _cfg.get("miner", {})
impl = miner_cfg.get("impl", "cpuminer")

try:
    if impl == "cpuminer":
        bin_path = miner_cfg.get("bin_path", "/usr/local/bin/minerd")
        ensure_cpuminer_binary(bin_path)
        miner_cfg["bin_path"] = bin_path
        _cfg["miner"] = miner_cfg
    elif impl == "srbminer":
        # 仅准备目录，具体 bin_path 可用默认
        ensure_srbminer("/opt/SRBMiner-Multi")
        if not miner_cfg.get("bin_path"):
            miner_cfg["bin_path"] = "/opt/SRBMiner-Multi/SRBMiner-MULTI"
            _cfg["miner"] = miner_cfg
    else:
        logging.warning("未知 miner.impl=%s，启动时不自动下载矿工。", impl)
except Exception as e:
    logging.error("自动下载 miner 失败: %s", e)

_miner = None
_watchdog = None



def ensure_objects():
    """根据当前配置，确保 _miner 存在；若配置完整则启动 Watchdog。"""
    global _cfg, _miner, _watchdog

    # 确保 Miner
    if _miner is None:
        _miner = Miner(_cfg)

    # 配置不完整就不要启动 Watchdog，否则会一直报“缺少 url/user”
    if not is_config_complete(_cfg):
        return

    # 只在还没有 Watchdog 时创建
    if _watchdog is None:
        _watchdog = Watchdog(_miner, _cfg)
        t = threading.Thread(target=_watchdog.run, daemon=True)
        t.start()



@app.route("/")
def index():
    return render_template_string(HTML_PAGE)


@app.get("/api/status")
def api_status():
    global _cfg, _miner, _watchdog
    needs_setup = not is_config_complete(_cfg)

    mcfg = _cfg.get("miner", {})
    wcfg = _cfg.get("watchdog", {})

    running = _miner.is_running() if _miner else False

    return jsonify(
        {
            "needs_setup": needs_setup,
            "running": running,
            "wallet": _cfg.get("wallet"),
            "pool_url": mcfg.get("url"),
            "threads": mcfg.get("threads"),
            "bin_path": mcfg.get("bin_path"),
            "algorithm": mcfg.get("algorithm"),
            "impl": mcfg.get("impl", "cpuminer"),
            "restart_count": _watchdog.restart_count if _watchdog else 0,
            "restart_delay": wcfg.get("restart_delay"),
        }
    )


@app.post("/api/setup")
def api_setup():
    """
    首次配置/更新配置：
    body: {impl, wallet, pool_url, bin_path, threads?}
    """
    global _cfg, _miner, _watchdog
    data = request.get_json(force=True) or {}

    impl = (data.get("impl") or "cpuminer").strip()
    wallet = (data.get("wallet") or "").strip()
    pool_url = (data.get("pool_url") or "").strip()
    bin_path = (data.get("bin_path") or "").strip()
    threads = data.get("threads")

    if not wallet:
        return jsonify({"ok": False, "error": "钱包地址不能为空"}), 400
    if not pool_url:
        return jsonify({"ok": False, "error": "矿池地址不能为空"}), 400

    import os

    if threads is None:
        auto_threads = max(1, (os.cpu_count() or 2) - 1)
        threads = auto_threads

    try:
        threads = int(threads)
        if threads <= 0:
            raise ValueError
    except Exception:
        return jsonify({"ok": False, "error": "线程数必须是正整数"}), 400

    # 更新基础配置
    _cfg["wallet"] = wallet
    mcfg = _cfg.get("miner", {})
    mcfg["impl"] = impl
    mcfg["url"] = pool_url
    mcfg["user"] = wallet
    mcfg["threads"] = threads

    # bin_path 默认
    if bin_path:
        mcfg["bin_path"] = bin_path
    else:
        if impl == "cpuminer":
            mcfg["bin_path"] = "/usr/local/bin/minerd"
        elif impl == "srbminer":
            mcfg["bin_path"] = "/opt/SRBMiner-Multi/SRBMiner-MULTI"

    # algorithm / extra_args
    if impl == "cpuminer":
        mcfg["algorithm"] = "randomx"
        mcfg["extra_args"] = ""
    elif impl == "srbminer":
        # 自动拼一份 SRBMiner 参数
        host_port = _strip_stratum_prefix(pool_url)
        mcfg["algorithm"] = "randomx_scash"
        mcfg["extra_args"] = (
            f"--algorithm randomx_scash --pool {host_port} --wallet {wallet} "
            f"--password x --cpu-threads {threads}"
        )

    _cfg["miner"] = mcfg

    # 若没有 logging 段，可以补一个默认
    if "logging" not in _cfg:
        _cfg["logging"] = {
            "file": "/data/scash-manager.log",
            "level": "INFO",
        }

# 保存配置 ...
save_config(_cfg)
logging.info("已更新配置并写入文件。")

# 根据 impl 再确保 miner 已安装（下载二进制）
try:
    if impl == "cpuminer":
        ensure_cpuminer_binary(mcfg["bin_path"])
    elif impl == "srbminer":
        ensure_srbminer("/opt/SRBMiner-Multi")
except Exception as e:
    logging.error("配置后自动下载 miner 失败: %s", e)

# 重建 Miner / Watchdog
global _miner, _watchdog
if _miner and _miner.is_running():
    _miner.stop()

_miner = None         # 先置空，让 ensure_objects 按新配置重建
_watchdog = None      # 旧的 watchdog 不再用

ensure_objects()      # 按新的 _cfg 重建 _miner 和 _watchdog

# 启动 Miner
if _miner:
    _miner.start()


    return jsonify({"ok": True})


@app.post("/api/start")
def api_start():
    global _cfg, _miner
    if not is_config_complete(_cfg):
        return jsonify({"ok": False, "error": "配置未完成，请先在向导中填写钱包和矿池。"}), 400
    _miner.start()
    return jsonify({"ok": True, "message": "已请求启动 Miner"})


@app.post("/api/stop")
def api_stop():
    global _miner
    if _miner:
        _miner.stop()
    return jsonify({"ok": True, "message": "已请求停止 Miner"})


def main():
    logging.info("SCASH Manager Web 控制台已启动：http://0.0.0.0:8080")
    app.run(host="0.0.0.0", port=8080)


if __name__ == "__main__":
    main()
